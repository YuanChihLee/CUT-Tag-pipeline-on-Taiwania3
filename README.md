# CUT&Tag Data Analysis Pipeline on Taiwania3

This document describes the output structure and files generated by the automated CUT&Tag analysis pipeline. All outputs are organized within the project's root directory (`proj_root`).

## Table of Contents
- [Overall Directory Structure](#overall-directory-structure)
- [Directory Descriptions](#directory-descriptions)
  - [01 - Trimmed FASTQ](#01---trimmed-fastq)
  - [02 - Alignments (BAM)](#02---alignments-bam)
  - [03 - Browser Tracks (BigWig)](#03---browser-tracks-bigwig)
  - [04 - Peak Calling](#04---peak-calling)
  - [05 - Signal Quantification](#05---signal-quantification)
  - [Logs & QC](#logs--qc)
- [How to Visualize Tracks](#how-to-visualize-tracks)

---

## Overall Directory Structure

The pipeline generates the following directories and files:

```
.
├── 00_raw_data/
├── 01_trimmed_fastq/
├── 02_alignment_bam/
├── 03_browser_tracks/
│   ├── cpm_normalized_bw/
│   ├── raw_bw/
│   └── spike-in_normalized_bw/
├── 04_peaks/
│   ├── MACS3_individual/
│   ├── MACS3_replicate_merged/
│   ├── MACS3_mark_consensus/
│   └── SEACR_individual/
├── 05_quantification_counts/
├── logs/
└── QC_summary.txt
```

---

## Directory Descriptions

### 01 - Trimmed FASTQ

-   **Directory**: `01_trimmed_fastq/`
-   **Purpose**: Contains raw sequencing reads after adapter trimming and quality filtering. These are the clean input files for the alignment step.
-   **Key Files**: `*._R1.paired.fastq.gz`, `*._R2.paired.fastq.gz`
-   **Generation Method**: The `Trimmomatic` tool is used to remove adapter sequences and low-quality bases from the raw FASTQ files located in `00_raw_data/`.

### 02 - Alignments (BAM)

-   **Directory**: `02_alignment_bam/`
-   **Purpose**: Contains the final, analysis-ready alignment files in Binary Alignment Map (BAM) format.
-   **Key Files**: `*.final.bam`, `*.final.bam.bai`
-   **Generation Method**:
    1.  Trimmed FASTQ reads are aligned to the reference genome (e.g., `mm39`) and a spike-in genome (e.g., `yeast`) using `bowtie2`.
    2.  The resulting SAM files are converted to BAM, sorted, and indexed using `samtools`.
    3.  PCR duplicates are removed using `Picard MarkDuplicates`.
    4.  The final BAM files are filtered for properly paired reads (`-f 0x2`) and high mapping quality (`-q 10`). These files serve as the input for peak calling and signal quantification.

### 03 - Browser Tracks (BigWig)

-   **Directory**: `03_browser_tracks/`
-   **Purpose**: Stores genome browser tracks in the BigWig (`.bw`) format for visual inspection of signal enrichment (peaks).
-   **Subdirectories & Normalization Methods**:
    1.  **`raw_bw/`**: Contains un-normalized signal tracks. The read counts from fragment BED files are directly converted to signal density.
        -   **Use Case**: Primarily for initial data quality assessment. **Not suitable for comparing samples.**
    2.  **`cpm_normalized_bw/`**: Contains Counts Per Million (CPM) normalized tracks. The signal is scaled based on the total number of mapped reads in each library (`samtools view -c -F 0x04 *.final.bam`).
        -   **Use Case**: Good for comparing samples with different sequencing depths **within the same experimental condition**.
    3.  **`spike-in_normalized_bw/`**: Contains tracks normalized using an external spike-in control. The signal is scaled by a factor derived from the number of reads aligned to the spike-in genome (`10000 / (spikein_reads / 2)`).
        -   **Use Case**: The most reliable method for comparing signals **between different treatments or conditions**, as it accounts for both sequencing depth and technical variations.
-   **Generation Method**: Fragment coverage is first calculated from the final BAM files using `bedtools genomecov`. The resulting bedGraph files are then scaled according to the normalization strategy and converted to BigWig format using `bedGraphToBigWig`.

### 04 - Peak Calling

-   **Directory**: `04_peaks/`
-   **Purpose**: Contains peak files in BED format, identifying regions of significant signal enrichment. This directory is organized by the peak calling strategy.
-   **Subdirectories & Generation Method**:
    1.  **`SEACR_individual/`**: Contains peaks called on individual samples using `SEACR` in "non-stringent" mode with a `0.01` threshold on the spike-in normalized bedGraph data.
    2.  **`MACS3_individual/`**: Contains peaks called on individual samples using `MACS3` (`callpeak -f BAMPE -g mm -q 0.01`). The raw peaks are subsequently filtered to remove regions present in the ENCODE blacklist. The final output is `*.final_filtered_peaks.bed`.
    3.  **`MACS3_replicate_merged/`**: Contains reproducible peaks found by intersecting the `*.final_filtered_peaks.bed` files from biological replicates of the same condition (e.g., `H3K4me3_Control_1` and `H3K4me3_Control_2`). The intersection is performed using `bedtools intersect`.
    4.  **`MACS3_mark_consensus/`**: Contains a "consensus" peak set for each histone mark (e.g., all `H3K4me3` peaks from all conditions). This is generated by concatenating and merging all reproducible peaks for that mark using `bedtools merge`.

### 05 - Signal Quantification

-   **Directory**: `05_quantification_counts/`
-   **Purpose**: Contains the final count matrices, which are essential for downstream differential binding analysis (e.g., with DESeq2).
-   **Key Files**: `*_Raw_Counts.txt`
-   **Generation Method**:
    1.  A GTF annotation file is created from the consensus peak set for each histone mark.
    2.  The `featureCounts` tool is used to count the number of read pairs from each sample's `*.final.bam` file that overlap with the consensus peaks.
    3.  The output is a raw count table where rows are consensus peaks (genes in this context) and columns are samples.

### Logs & QC

-   **Directory**: `logs/`
-   **Purpose**: A comprehensive directory containing all log files generated during the pipeline's execution. This is the first place to look for debugging information.
-   **Key Files**:
    -   `*.trimmomatic.log`: Trimming statistics.
    -   `*_bowtie2.log`, `*_spikein.log`: Alignment rates for the primary and spike-in genomes.
    -   `*_macs3.log`: Log output from the MACS3 peak caller.
    -   `parallel_*.log`: GNU Parallel job logs for tracking execution status.
    -   `log_counting_*.log`: Detailed logs for the parallel featureCounts step.
-   **File**: `QC_summary.txt`
-   **Purpose**: A tab-separated summary file consolidating key quality control metrics, such as alignment rates and Fraction of Reads in Peaks (FrIP) scores, for all samples.

---

## How to Visualize Tracks

We recommend using the **[Integrative Genomics Viewer (IGV)](https://software.broadinstitute.org/software/igv/)** to view the `.bw` files from the `03_browser_tracks/` directory.

1.  **Launch IGV**.
2.  **Load Genome**: Select the appropriate reference genome (e.g., `mm39`) from the dropdown menu in the top-left.
3.  **Load Tracks**: Drag and drop the `.bw` files from one of the subdirectories (e.g., `spike-in_normalized_bw/`) onto the IGV window, or use the menu `File > Load from File...`.
